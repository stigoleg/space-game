name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write

jobs:
  build:
    name: Build for ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux
          - os: ubuntu-latest
            platform: linux
            arch: amd64
            goos: linux
            goarch: amd64
            output: stellar-siege
            artifact: stellar-siege-linux-amd64
            
          # macOS Intel
          - os: macos-latest
            platform: darwin
            arch: amd64
            goos: darwin
            goarch: amd64
            output: stellar-siege
            artifact: stellar-siege-darwin-amd64
            
          # macOS Apple Silicon
          - os: macos-latest
            platform: darwin
            arch: arm64
            goos: darwin
            goarch: arm64
            output: stellar-siege
            artifact: stellar-siege-darwin-arm64
            
          # Windows
          - os: windows-latest
            platform: windows
            arch: amd64
            goos: windows
            goarch: amd64
            output: stellar-siege.exe
            artifact: stellar-siege-windows-amd64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'
          cache: true
      
      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libc6-dev libgl1-mesa-dev libxcursor-dev libxi-dev libxinerama-dev libxrandr-dev libxxf86vm-dev libasound2-dev pkg-config
      
      - name: Validate secrets
        shell: bash
        run: |
          if [ -z "${{ secrets.GIST_ID }}" ]; then
            echo "ERROR: GIST_ID secret is not set!"
            echo "Please add GIST_ID to your GitHub repository secrets"
            exit 1
          fi
          if [ -z "${{ secrets.GH_GIST_TOKEN }}" ]; then
            echo "ERROR: GH_GIST_TOKEN secret is not set!"
            echo "Please add GH_GIST_TOKEN to your GitHub repository secrets"
            exit 1
          fi
          echo "✓ All required secrets are present"
          echo "  GIST_ID: ${GIST_ID:0:8}..." 
          echo "  GH_GIST_TOKEN: ${GH_GIST_TOKEN:0:8}..."
        env:
          GIST_ID: ${{ secrets.GIST_ID }}
          GH_GIST_TOKEN: ${{ secrets.GH_GIST_TOKEN }}
      
      - name: Create .env file from secrets
        shell: bash
        run: |
          cat > .env << 'EOF'
          GIST_ID=${{ secrets.GIST_ID }}
          GH_GIST_TOKEN=${{ secrets.GH_GIST_TOKEN }}
          GIST_ENABLED=true
          EOF
          echo "Created .env file with secrets"
          echo "Verifying .env file contents (redacted):"
          sed 's/=.*/=***/' .env
        
      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
        run: |
          go build -ldflags="-s -w" -o ${{ matrix.output }} .
      
      - name: Create macOS .app bundle (Intel)
        if: matrix.platform == 'darwin' && matrix.arch == 'amd64'
        run: |
          APP_NAME="Stellar Siege"
          BINARY_NAME="stellar-siege"
          BUNDLE_ID="com.stellarsiege.game"
          VERSION="${GITHUB_REF#refs/tags/}"
          
          APP_DIR="$APP_NAME.app/Contents"
          mkdir -p "$APP_DIR/MacOS"
          mkdir -p "$APP_DIR/Resources/assets"
          mkdir -p "$APP_DIR/Resources/config"
          
          # Copy binary
          cp "$BINARY_NAME" "$APP_DIR/MacOS/"
          
          # Copy .env file with secrets to Resources
          cp .env "$APP_DIR/Resources/.env"
          echo "✓ Copied .env file to app bundle"
          
          # Copy assets
          if [ -d "assets" ]; then
            cp -r assets/* "$APP_DIR/Resources/assets/" 2>/dev/null || true
          fi
          
          if [ -d "config" ]; then
            cp -r config/* "$APP_DIR/Resources/config/" 2>/dev/null || true
          fi
          
          # Create Info.plist
          cp build_resources/Info.plist "$APP_DIR/" || cat > "$APP_DIR/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>$BINARY_NAME</string>
              <key>CFBundleName</key>
              <string>$APP_NAME</string>
              <key>CFBundleDisplayName</key>
              <string>$APP_NAME</string>
              <key>CFBundleIdentifier</key>
              <string>$BUNDLE_ID</string>
              <key>CFBundleVersion</key>
              <string>$VERSION</string>
              <key>CFBundleShortVersionString</key>
              <string>$VERSION</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleSignature</key>
              <string>STSG</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>LSApplicationCategoryType</key>
              <string>public.app-category.games</string>
          </dict>
          </plist>
          EOF
          
          # Create PkgInfo
          echo "APPLSTSG" > "$APP_DIR/PkgInfo"
          
          # Make binary executable
          chmod +x "$APP_DIR/MacOS/$BINARY_NAME"
          
          # Create DMG
          hdiutil create -volname "$APP_NAME" -srcfolder "$APP_NAME.app" -ov -format UDZO "Stellar-Siege-macOS-Intel.dmg"
      
      - name: Create macOS .app bundle (Apple Silicon)
        if: matrix.platform == 'darwin' && matrix.arch == 'arm64'
        run: |
          APP_NAME="Stellar Siege"
          BINARY_NAME="stellar-siege"
          BUNDLE_ID="com.stellarsiege.game"
          VERSION="${GITHUB_REF#refs/tags/}"
          
          APP_DIR="$APP_NAME.app/Contents"
          mkdir -p "$APP_DIR/MacOS"
          mkdir -p "$APP_DIR/Resources/assets"
          mkdir -p "$APP_DIR/Resources/config"
          
          # Copy binary
          cp "$BINARY_NAME" "$APP_DIR/MacOS/"
          
          # Copy .env file with secrets to Resources
          cp .env "$APP_DIR/Resources/.env"
          echo "✓ Copied .env file to app bundle"
          
          # Copy assets
          if [ -d "assets" ]; then
            cp -r assets/* "$APP_DIR/Resources/assets/" 2>/dev/null || true
          fi
          
          if [ -d "config" ]; then
            cp -r config/* "$APP_DIR/Resources/config/" 2>/dev/null || true
          fi
          
          # Create Info.plist
          cp build_resources/Info.plist "$APP_DIR/" || cat > "$APP_DIR/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>$BINARY_NAME</string>
              <key>CFBundleName</key>
              <string>$APP_NAME</string>
              <key>CFBundleDisplayName</key>
              <string>$APP_NAME</string>
              <key>CFBundleIdentifier</key>
              <string>$BUNDLE_ID</string>
              <key>CFBundleVersion</key>
              <string>$VERSION</string>
              <key>CFBundleShortVersionString</key>
              <string>$VERSION</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleSignature</key>
              <string>STSG</string>
              <key>LSMinimumSystemVersion</key>
              <string>11.0</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>LSApplicationCategoryType</key>
              <string>public.app-category.games</string>
          </dict>
          </plist>
          EOF
          
          # Create PkgInfo
          echo "APPLSTSG" > "$APP_DIR/PkgInfo"
          
          # Make binary executable
          chmod +x "$APP_DIR/MacOS/$BINARY_NAME"
          
          # Create DMG
          hdiutil create -volname "$APP_NAME" -srcfolder "$APP_NAME.app" -ov -format UDZO "Stellar-Siege-macOS-AppleSilicon.dmg"
      
      - name: Package Linux release
        if: matrix.platform == 'linux'
        run: |
          mkdir -p stellar-siege-linux
          cp stellar-siege stellar-siege-linux/
          cp .env stellar-siege-linux/.env
          cp -r assets stellar-siege-linux/ 2>/dev/null || true
          cp -r config stellar-siege-linux/ 2>/dev/null || true
          cp .env.example stellar-siege-linux/.env.example
          echo "✓ Packaged Linux release with .env file"
          tar -czf stellar-siege-linux-amd64.tar.gz stellar-siege-linux
      
      - name: Package Windows release
        if: matrix.platform == 'windows'
        shell: bash
        run: |
          mkdir -p stellar-siege-windows
          cp stellar-siege.exe stellar-siege-windows/
          cp .env stellar-siege-windows/.env
          cp -r assets stellar-siege-windows/ 2>/dev/null || true
          cp -r config stellar-siege-windows/ 2>/dev/null || true
          cp .env.example stellar-siege-windows/.env.example
          echo "✓ Packaged Windows release with .env file"
          7z a -tzip stellar-siege-windows-amd64.zip stellar-siege-windows
      
      - name: Upload artifacts - macOS Intel
        if: matrix.platform == 'darwin' && matrix.arch == 'amd64'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: Stellar-Siege-macOS-Intel.dmg
          retention-days: 5
      
      - name: Upload artifacts - macOS Apple Silicon
        if: matrix.platform == 'darwin' && matrix.arch == 'arm64'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: Stellar-Siege-macOS-AppleSilicon.dmg
          retention-days: 5
      
      - name: Upload artifacts - Linux
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: stellar-siege-linux-amd64.tar.gz
          retention-days: 5
      
      - name: Upload artifacts - Windows
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: stellar-siege-windows-amd64.zip
          retention-days: 5

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display structure of downloaded files
        run: ls -R artifacts
      
      - name: Generate SHA256 checksums
        run: |
          cd artifacts
          echo "# SHA256 Checksums" > ../checksums.txt
          echo "" >> ../checksums.txt
          echo "Verify your download integrity:" >> ../checksums.txt
          echo '```' >> ../checksums.txt
          find . -type f \( -name "*.dmg" -o -name "*.tar.gz" -o -name "*.zip" \) -exec sh -c 'sha256sum "{}" | sed "s|^\./||" | sed "s|.*/||"' \; >> ../checksums.txt
          echo '```' >> ../checksums.txt
          cd ..
          echo ""
          echo "Generated checksums:"
          cat checksums.txt
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/stellar-siege-darwin-amd64/Stellar-Siege-macOS-Intel.dmg
            artifacts/stellar-siege-darwin-arm64/Stellar-Siege-macOS-AppleSilicon.dmg
            artifacts/stellar-siege-linux-amd64/stellar-siege-linux-amd64.tar.gz
            artifacts/stellar-siege-windows-amd64/stellar-siege-windows-amd64.zip
            checksums.txt
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Stellar Siege Release
            
            Cross-platform builds for Linux, macOS (Intel & Apple Silicon), and Windows.
            
            ### Downloads:
            - **macOS Intel**: Stellar-Siege-macOS-Intel.dmg
            - **macOS Apple Silicon**: Stellar-Siege-macOS-AppleSilicon.dmg
            - **Linux**: stellar-siege-linux-amd64.tar.gz
            - **Windows**: stellar-siege-windows-amd64.zip
            - **Checksums**: checksums.txt
            
            ### Security Notice:
            **First-time users may see security warnings** - this is normal for unsigned applications.
            - See [SECURITY.md](https://github.com/${{ github.repository }}/blob/main/SECURITY.md) for instructions on bypassing these warnings safely
            - Verify your download using the SHA256 checksums provided in checksums.txt
            
            ### Setup Instructions:
            1. Download the appropriate file for your platform
            2. **Verify checksum** (recommended): Compare SHA256 hash with checksums.txt
            3. Extract/mount the archive
            4. **First launch**: Follow security instructions in SECURITY.md if you see warnings
            5. (Optional) Configure GitHub Gist leaderboard by copying `.env.example` to `.env` and adding your credentials
            6. Run the game and enjoy!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
